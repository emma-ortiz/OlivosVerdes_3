<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tu Carrito | Olivos Verdes</title>
    {% load static %}
    <style>
        body {
            background-color: #1b120d;
            color: #fff;
            font-family: 'Verdana', sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            background-color: #1b120d;
            padding: 20px;
            color: #66842f;
            font-size: 24px;
            font-weight: bold;
            width: 100%;
            box-sizing: border-box;
        }

        header img {
            height: 50px;
            margin-right: 10px;
        }

        h1 {
            margin: 20px 0 10px;
            font-size: 28px;
        }

        main {
            flex: 1;
            padding: 40px 20px;
            width: 90%;
            max-width: 900px;
        }

        h2 {
            color: #ffce73;
            text-align: center;
            margin-bottom: 30px;
            font-size: 32px;
        }

        /* --- Tabla de Art√≠culos --- */
        .tabla-carrito {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background-color: #241913;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        .tabla-carrito th, .tabla-carrito td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        .tabla-carrito th {
            background-color: #66842f;
            color: #fff;
            font-size: 16px;
        }

        .tabla-carrito td {
            color: #ddd;
        }

        .item-info {
            display: flex;
            align-items: center;
        }

        .item-info img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 15px;
        }
        
        /* --- Totales y Bot√≥n --- */
        .resumen-total {
            text-align: right;
            padding: 20px;
            background-color: #241913;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        .resumen-total p {
            font-size: 15px;
            font-weight: bold;
            margin: 5px 0;
        }

        .resumen-total p.total {
            color: #ffce73;
            font-size: 20px;
            border-top: 2px dashed #444;
            padding-top: 10px;
            margin-top: 10px;
        }
        
        .btn-checkout {
            background-color: #7fa650;
            color: #fff;
            padding: 15px 30px;
            margin-top: 25px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: background-color 0.2s ease-in-out;
        }

        .btn-checkout:hover {
            background-color: #94c163;
        }

        /* --- Mensaje de Carrito Vac√≠o --- */
        .carrito-vacio {
            text-align: center;
            padding: 50px;
            color: #ddd;
        }

        .carrito-vacio a {
            color: #ffce73;
            text-decoration: none;
            font-weight: bold;
        }

        /* --- Barra Hamburguesa (Estilos ya conocidos) --- */
        .hamburger-icon { display: block; position: fixed; top: 15px; right: 15px; z-index: 1000; background: none; border: none; font-size: 30px; cursor: pointer; color: #66842f; }
        .menu-nav { position: fixed; top: 0; right: 0; width: 250px; height: 100%; background-color: #66842f; z-index: 999; transform: translateX(100%); transition: transform 0.3s ease-in-out; }
        .menu-nav.active { transform: translateX(0); }
        .menu-nav ul { list-style: none; padding: 70px 0 0 0; margin: 0; }
        .menu-nav li a { display: block; padding: 15px 20px; text-decoration: none; color: white; border-bottom: 1px solid #555; }
        .menu-nav li a:hover { background-color: #555; }
        footer { background-color: #1b120d; color: #aaa; padding: 15px; font-size: 13px; text-align: center; margin-top: auto; width: 100%;}

        /* Bot√≥n de eliminar (Rojo) */
        .btn-eliminar {
            background-color: #ff4d4d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }
        .btn-eliminar:hover {
            background-color: #e60000;
        }
          /* --- Nuevos Estilos para Submen√∫s --- */
            .menu-nav li.has-submenu {
                position: relative;
            }

            /* Submen√∫ oculto por defecto */
            .menu-nav .submenu {
                display: none;
                list-style: none;
                padding: 0;
                margin: 0;
                background-color: #271b04ff;
                border-top: 1px solid #271b04ff;
            }

            /* Mostrar submen√∫ solo cuando tiene la clase .show */
            .menu-nav .submenu.show {
                display: block;
            }

            /* √çtems del submen√∫ */
            .menu-nav .submenu li a {
                padding: 10px 20px 10px 30px;
                font-size: 14px;
                background-color: #271b04ff;
            }

            .menu-nav .submenu li a:hover {
                text-decoration: underline;
            }

            /* Estilo para el bot√≥n Categor√≠as */
            .menu-nav li.has-submenu > a {
                font-weight: bold;
            }

            .menu-nav li.has-submenu > a:hover {
                background-color: #3a2706;
                color: white;
            }
    </style>
</head>
<body>
    <header>
        <img src="{% static 'app_fruteria/imagenes/icon.jpg' %}" alt="Logo">
        <span>Olivos Verdes</span>
    </header>

     <button class="hamburger-icon" id="menu-btn">‚ò∞</button>
    
    <nav class="menu-nav" id="menu">
    <ul>
        <li><a href="{% url 'ver_ofertas' %}">Ofertas</a></li>
        
        <li class="has-submenu">
            <a href="#">Categor√≠as ‚ñæ</a>
            <ul class="submenu">
                <li><a href="{% url 'menu_virtual' %}">Todo el Men√∫</a></li>
                <li><a href="{% url 'frutas_citricas' %}">C√≠tricas</a></li>
                <li><a href="{% url 'frutas_dulces' %}">Dulces</a></li>
                <li><a href="{% url 'frutas_neutras' %}">Neutras</a></li>
            </ul>
        </li>
        <li><a href="{% url 'ver_carrito' %}">Carrito</a></li>
        <li><a href="{% url 'confirmar_compra' %}">Comprar</a></li>
        <li><a href="{% url 'perfil' %}">Perfil</a></li>
    </ul>
</nav>


    <main>
        <h2>Cesta de Compras</h2>
        
        {% if carrito_items %}
            <table class="tabla-carrito">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Precio Unitario</th>
                        <th>Cantidad</th>
                        <th>Subtotal</th>
                        <th>Acci√≥n</th>
                    </tr>
                </thead>
                <tbody>
    {% for item in carrito_items %}
    <tr id="row-{{ item.producto.id }}"> 
        <td>
            <div class="item-info">
                {% if item.producto.imagen %}
                    <img src="{{ item.producto.imagen.url }}" alt="{{ item.producto.nombre }}">
                {% else %}
                    <img src="{% static 'app_fruteria/imagenes/placeholder.jpg' %}" alt="{{ item.producto.nombre }}">
                {% endif %}
                {{ item.producto.nombre }}
            </div>
        </td>
        
        <td>${{ item.precio_unitario|floatformat:2 }}</td>
        
        <td>
            <div style="display: flex; align-items: center; justify-content: space-around; width: 100px;">
                <a href="{% url 'ajustar_cantidad' item.producto.id 'disminuir' %}" 
                   style="text-decoration: none; padding: 5px 10px; background-color: #ff4d4d; color: white; border-radius: 5px; font-weight: bold;">
                    -
                </a>
                
                <span style="font-weight: bold; margin: 0 10px;">{{ item.cantidad }}</span>
                
                <a href="{% url 'ajustar_cantidad' item.producto.id 'aumentar' %}" 
                   style="text-decoration: none; padding: 5px 10px; background-color: #7fa650; color: white; border-radius: 5px; font-weight: bold;">
                    +
                </a>
            </div>
            <span style="font-size: 12px; display: block; text-align: center;">kg</span>
        </td>
        
        <td>${{ item.subtotal|floatformat:2 }}</td>
        <td>
            <a href="#" class="btn-eliminar js-remove-item" data-product-id="{{ item.producto.id }}" data-row-id="row-{{ item.producto.id }}">
                Eliminar
            </a>
        </td>
    </tr>
    {% endfor %}
</tbody>
            </table>
            
            <div class="resumen-total">
                <p>Subtotal de productos: 
                    <span id="subtotal-productos">${{ total_general|floatformat:2 }}</span>
                </p>
                <p>Costo de env√≠o: 
                    <span id="costo-envio">$40.00</span>
                </p>
                
                <p class="total">Total a pagar: 
                    <span id="total-final">${{ total_general|add:40|floatformat:2 }}</span>
                </p>

                <a href="{% url 'confirmar_compra' %}" class="btn-checkout">
                    Proceder a Comprar
                </a>
            </div>

        {% else %}
            <div class="carrito-vacio">
                <p>Tu cesta est√° vac√≠a. ¬°A√±ade deliciosas frutas y verduras!</p>
                <a href="{% url 'menu_virtual' %}">Explorar el Men√∫</a>
            </div>
        {% endif %}

    </main>

    <footer>
        Copyright | Fruter√≠a Olivos Verdes
    </footer>

    <script>
        /* -------------------------
        MEN√ö HAMBURGUESA
        ----------------------------*/
        const menuBtn = document.getElementById('menu-btn');
        const menu = document.getElementById('menu');
        menuBtn.addEventListener('click', () => menu.classList.toggle('active'));


        /* -------------------------
        SUBMEN√ö DE CATEGOR√çAS
        ----------------------------*/
        const submenuToggle = document.querySelector('.has-submenu > a');
        const submenu = document.querySelector('.has-submenu .submenu');

        submenuToggle.addEventListener('click', function(e) {
            e.preventDefault();
            submenu.classList.toggle('show');
        });


        /* -------------------------
        TOAST / NOTIFICACIONES
        ----------------------------*/
        function showToastMessage(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            // Estilos b√°sicos (idealmente en CSS)
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                background-color: ${type === 'success' ? '#7fa650' : '#ff4d4d'};
                color: white;
                border-radius: 5px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                z-index: 9999;
                opacity: 0;
                transition: opacity 0.5s, transform 0.5s;
                transform: translateY(-50px);
                font-family: sans-serif;
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = 1;
                toast.style.transform = 'translateY(0)';
            }, 10);

            setTimeout(() => {
                toast.style.opacity = 0;
                toast.style.transform = 'translateY(-50px)';
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000); 
        }

        // Aseguramos que el c√≥digo se ejecute cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            
            // ... L√≥gica del men√∫ hamburguesa ...

    // -------------------------------------------------------------
    // L√ìGICA AJAX PARA ELIMINAR DEL CARRITO (Suave y Actualizaci√≥n de Totales)
    // -------------------------------------------------------------
    document.querySelectorAll('.js-remove-item').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault(); 

            const productId = this.dataset.productId;
            const rowId = this.dataset.rowId;
            const url = `/eliminar-carrito/${productId}/`;
            
            fetch(url, {
                method: 'GET', 
                headers: {
                    'X-Requested-With': 'XMLHttpRequest', 
                }
            })
            .then(response => {
                // Si la respuesta no es 200 OK, lanzamos un error para el .catch
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showToastMessage(data.message); 

                    // 1. Eliminar visualmente la fila
                    const rowToRemove = document.getElementById(rowId);
                    if (rowToRemove) {
                        rowToRemove.remove();
                    }
                    
                    // üö® 2. C√ìDIGO CLAVE: ACTUALIZAR TOTALES üö®
                    const subtotalElement = document.getElementById('subtotal-productos');
                    const totalElement = document.getElementById('total-final');
                    
                    // La vista de Python devuelve los nuevos totales
                    const newSubtotal = parseFloat(data.new_subtotal);
                    const newTotalFinal = parseFloat(data.new_total_final);

                    if (subtotalElement) {
                        // Actualizamos el subtotal (ej. $50.00)
                        subtotalElement.textContent = `$${newSubtotal.toFixed(2)}`;
                    }
                    if (totalElement) {
                         // Actualizamos el total final (ej. $90.00)
                        totalElement.textContent = `$${newTotalFinal.toFixed(2)}`;
                    }
                    
                    // 3. Si el subtotal es 0, forzamos la recarga
                    if (newSubtotal <= 0) {
                        // Forzamos la recarga para que Django muestre la secci√≥n de carrito vac√≠o
                        setTimeout(() => window.location.reload(), 500); 
                    }

                } else {
                    showToastMessage(data.message || 'Error al eliminar el producto.', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Si falla el fetch, es el error de conexi√≥n que ve el usuario
                showToastMessage('Error de conexi√≥n con el servidor. Revisa la consola.', 'error');
            });
        });
    });

    // -------------------------------------------------------------
    // L√ìGICA AJAX PARA A√ëADIR AL CARRITO (Suave) - Necesaria para que exista showToastMessage
    // -------------------------------------------------------------
    document.querySelectorAll('.js-add-to-cart').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.dataset.productId;
            const url = `/agregar-carrito/${productId}/`; 
            
            fetch(url, {
                method: 'GET', 
                headers: {
                    'X-Requested-With': 'XMLHttpRequest', 
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToastMessage(data.message);
                } else {
                    showToastMessage('Error al a√±adir el producto.', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToastMessage('Error de conexi√≥n al a√±adir.', 'error');
            });
        });
    });

}); // Fin DOMContentLoaded
</script>

</body>
</html>